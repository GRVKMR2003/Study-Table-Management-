<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üìö Library Study Table Management</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f9;
      padding: 20px;
      color: #333;
    }

    h1 {
      color: #4a148c;
    }

    .form-section, .table-section {
      background: #fff;
      padding: 20px;
      margin: 20px 0;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    label {
      display: block;
      margin: 10px 0 5px;
    }

    input, select, button {
      padding: 10px;
      margin-bottom: 10px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    button {
      background: #4a148c;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background: #6a1b9a;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: center;
    }

    th {
      background-color: #4a148c;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .occupied {
      background-color: #ffe6e6;
    }

    .available {
      background-color: #e6ffe6;
    }
  </style>
</head>
<body>

  <h1>üìö Study Table Management</h1>

  <div class="form-section">
    <h2>Assign Student to Table (Manual)</h2>
    <form id="assignForm">
      <label for="tableId">Table ID</label>
      <input type="number" id="tableId" required>

      <label for="studentName">Student Name</label>
      <input type="text" id="studentName" required>

      <button type="submit">Assign</button>
    </form>
  </div>

  <div class="form-section">
    <h2>Free Table by ID (Manual)</h2>
    <form id="freeForm">
      <label for="freeTableId">Table ID</label>
      <input type="number" id="freeTableId" required>
      <button type="submit">Free Table</button>
    </form>
  </div>

  <div class="table-section">
    <h2>üìã All Study Tables</h2>
    <button onclick="loadTables()">üîÑ Refresh</button>
    <table id="tableList">
      <thead>
        <tr>
          <th>ID</th>
          <th>Room</th>
          <th>Table #</th>
          <th>Status</th>
          <th>Student</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    async function api(method, url) {
      const res = await fetch(url, { method });
      if (!res.ok) throw new Error(await res.text());
      return res.json().catch(() => ({}));
    }

    function renderRow(t) {
      const tr = document.createElement('tr');
      tr.dataset.id = t.id;
      tr.className = t.occupied ? 'occupied' : 'available';
      tr.innerHTML = `
        <td>${t.id}</td>
        <td>${t.roomNumber}</td>
        <td>${t.tableNumber}</td>
        <td class="status">${t.occupied ? 'Occupied' : 'Available'}</td>
        <td class="student">${t.assignedStudent ?? '-'}</td>
        <td class="action">
          ${t.occupied
            ? `<button onclick="freeSeat(${t.id})">Free</button>`
            : `<button onclick="assignSeat(${t.id})">Assign</button>`}
        </td>`;
      return tr;
    }

    async function loadTables() {
      const tables = await api('GET', '/api/tables');
      const tbody  = document.querySelector('#tableList tbody');
      tbody.textContent = '';
      tables.forEach(t => tbody.appendChild(renderRow(t)));
    }

    async function freeSeat(id) {
      if (!confirm(`Free table ${id}?`)) return;
      try {
        await api('PUT', `/api/tables/${id}/free`);
        updateRow(id, { occupied: false, isAvailable: true, assignedStudent: null });
        alert('‚úÖ Table freed!');
      } catch (e) { alert('‚ùå ' + e.message); }
    }

    async function assignSeat(id) {
      const student = prompt('Student name:');
      if (!student) return;
      try {
        await api('PUT', `/api/tables/${id}/assign?studentName=${encodeURIComponent(student)}`);
        updateRow(id, { occupied: true, isAvailable: false, assignedStudent: student });
        alert('‚úÖ Assigned!');
      } catch (e) { alert('‚ùå ' + e.message); }
    }

    function updateRow(id, patch) {
      const tr       = document.querySelector(`tr[data-id="${id}"]`);
      const statusTd = tr.querySelector('.status');
      const studTd   = tr.querySelector('.student');
      const actTd    = tr.querySelector('.action');

      const occupied = patch.occupied;
      tr.className   = occupied ? 'occupied' : 'available';
      statusTd.textContent = occupied ? 'Occupied' : 'Available';
      studTd.textContent   = patch.assignedStudent ?? '-';
      actTd.innerHTML      = occupied
        ? `<button onclick="freeSeat(${id})">Free</button>`
        : `<button onclick="assignSeat(${id})">Assign</button>`;
    }

    document.getElementById('assignForm').addEventListener('submit', async e => {
      e.preventDefault();
      const id      = document.getElementById('tableId').value;
      const student = encodeURIComponent(document.getElementById('studentName').value);
      try {
        await api('PUT', `/api/tables/${id}/assign?studentName=${student}`);
        updateRow(id, { occupied: true, isAvailable: false, assignedStudent: decodeURIComponent(student) });
        alert('‚úÖ Assigned!');
      } catch (err) { alert('‚ùå ' + err.message); }
    });

    document.getElementById('freeForm').addEventListener('submit', async e => {
      e.preventDefault();
      const id = document.getElementById('freeTableId').value;
      try {
        await api('PUT', `/api/tables/${id}/free`);
        updateRow(id, { occupied: false, isAvailable: true, assignedStudent: null });
        alert('‚úÖ Freed!');
      } catch (err) { alert('‚ùå ' + err.message); }
    });

    loadTables();
  </script>

</body>
</html>
